<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√†i Tr·∫Øc Nghi·ªám - T·∫£i DOCX L√™n</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            position: relative;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        .upload-section {
            background-color: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #3498db;
            background-color: #e3f2fd;
        }
        
        .upload-section.dragover {
            border-color: #3498db;
            background-color: #e3f2fd;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .upload-text {
            margin-bottom: 20px;
            font-size: 16px;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .upload-btn:hover {
            background-color: #2980b9;
        }
        
        .file-info {
            margin-top: 15px;
            font-size: 14px;
            color: #6c757d;
        }
        
        .settings-section {
            background-color: #e8f4fc;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: left;
        }
        
        .settings-section h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .setting-option {
            margin: 8px 0;
            display: flex;
            align-items: center;
        }
        
        .setting-option input {
            margin-right: 8px;
        }
        
        .format-guide {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
        }
        
        .format-guide h4 {
            margin-bottom: 10px;
            color: #856404;
        }
        
        .format-guide ul {
            padding-left: 20px;
        }
        
        .format-guide li {
            margin-bottom: 5px;
        }
        
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .download-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #back-preview-btn {
            background-color: #95a5a6;
            color: #fff;
        }
        #back-preview-btn:hover { background-color: #7f8c8d; }
        
        .progress-container {
            margin-bottom: 30px;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            gap: 8px; /* ƒë·∫£m b·∫£o lu√¥n c√≥ kho·∫£ng c√°ch gi·ªØa 2 ph·∫ßn, tr√°nh d√≠nh th√†nh 254% */
            align-items: baseline;
            margin-top: 5px;
            font-size: 14px;
            color: #7f8c8d;
        }
        /* ·∫®n s·ªë ph·∫ßn trƒÉm ·ªü b√™n ph·∫£i theo y√™u c·∫ßu */
        #progress-percent { display: none; }
        
        .question-container {
            margin-bottom: 30px;
        }
        
        .question-number {
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .question-text {
            font-size: 18px;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .option {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
        }
        
        .option:hover {
            background-color: #f9f9f9;
        }
        
        .option.selected {
            border-color: #3498db;
            background-color: #e1f0fa;
        }
        
        .option.correct {
            border-color: #2ecc71;
            background-color: #e8f8ef;
        }
        
        .option.incorrect {
            border-color: #e74c3c;
            background-color: #fdedec;
        }
        
        /* Kh√≥a l·ª±a ch·ªçn sau khi ƒë√£ ch·ªçn */
        .option.disabled {
            pointer-events: none;
            cursor: default;
        }
        
        .feedback {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            display: none;
        }
        
        .feedback.correct {
            background-color: #e8f8ef;
            color: #27ae60;
            display: block;
        }
        
        .feedback.incorrect {
            background-color: #fdedec;
            color: #e74c3c;
            display: block;
        }
        
        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #prev-btn {
            background-color: #95a5a6;
            color: white;
        }
        
        #prev-btn:hover:not(:disabled) {
            background-color: #7f8c8d;
        }
        
        #next-btn {
            background-color: #3498db;
            color: white;
        }
        
        #next-btn:hover:not(:disabled) {
            background-color: #2980b9;
        }
        
        #download-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        #download-btn:hover {
            background-color: #27ae60;
        }
        
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .result-container {
            text-align: center;
            display: none;
        }
        
        .result-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .score {
            font-size: 48px;
            font-weight: bold;
            color: #3498db;
            margin: 20px 0;
        }
        
        .result-details {
            margin-top: 30px;
            text-align: left;
        }
        
        .result-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .result-item.correct {
            color: #27ae60;
        }
        
        .result-item.incorrect {
            color: #e74c3c;
        }
        
        #restart-btn {
            background-color: #2ecc71;
            color: white;
            margin-top: 20px;
        }
        
        #restart-btn:hover {
            background-color: #27ae60;
        }
        
        .hidden {
            display: none;
        }

        /* Preview & mode selection */
        #preview-section {
            margin-top: 10px;
        }
        .preview-list .preview-question {
            margin: 12px 0;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fafafa;
        }
        .preview-question .pq-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        .preview-question .pq-option {
            padding: 6px 8px;
            border-radius: 6px;
            margin: 4px 0;
            border: 1px solid #f0f0f0;
        }
        .preview-question .pq-option.correct {
            background: #e8f8ef;
            border-color: #2ecc71;
            color: #207a4f;
        }
        .mode-buttons {
            display: flex;
            gap: 12px;
            margin-top: 14px;
        }
        #start-test-btn { background-color: #8e44ad; color: #fff; }
        #start-test-btn:hover { background-color: #7c379a; }
        #start-practice-btn { background-color: #3498db; color: #fff; }
        #start-practice-btn:hover { background-color: #2980b9; }
        #back-upload-btn { background-color: #95a5a6; color: #fff; }
        #back-upload-btn:hover { background-color: #7f8c8d; }

        /* Test mode */
        #test-section { margin-top: 10px; }
        .test-question {
            margin: 12px 0;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        .test-question .tq-title { font-weight: 600; margin-bottom: 8px; }
        .test-options { display: grid; gap: 8px; }
        #submit-test-btn { background: #2ecc71; color: #fff; margin-top: 12px; }
        #submit-test-btn:hover { background: #27ae60; }
        
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .header-section {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .question-text {
                font-size: 16px;
            }
            
            .option {
                padding: 12px;
                font-size: 14px;
            }
            
            button {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>B√ÄI TR·∫ÆC NGHI·ªÜM</h1>
        
        <div class="upload-section" id="upload-section">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-text">
                <h3>T·∫£i file DOCX l√™n</h3>
                <p>K√©o th·∫£ file DOCX v√†o ƒë√¢y ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn file</p>
            </div>
            <input type="file" id="file-input" class="file-input" accept=".docx">
            <button class="upload-btn" id="upload-btn">Ch·ªçn File</button>
            <div class="file-info" id="file-info"></div>
            
            <div class="settings-section">
                <h4>C√†i ƒë·∫∑t ƒë·∫£o c√¢u h·ªèi:</h4>
                <div class="setting-option">
                    <input type="checkbox" id="shuffle-questions" checked>
                    <label for="shuffle-questions">ƒê·∫£o th·ª© t·ª± c√¢u h·ªèi</label>
                </div>
                <div class="setting-option">
                    <input type="checkbox" id="shuffle-options" checked>
                    <label for="shuffle-options">ƒê·∫£o th·ª© t·ª± ƒë√°p √°n</label>
                </div>
            </div>
            
            <div class="format-guide">
                <h4>H∆∞·ªõng d·∫´n ƒë·ªãnh d·∫°ng file DOCX:</h4>
                <ul>
                    <li><strong>C√¢u h·ªèi:</strong> B·∫Øt ƒë·∫ßu b·∫±ng "C√¢u X:" ho·∫∑c "X." (X l√† s·ªë th·ª© t·ª±)</li>
                    <li><strong>ƒê√°p √°n:</strong> B·∫Øt ƒë·∫ßu b·∫±ng "A.", "B.", "C.", "D."</li>
                    <li><strong>ƒê√°p √°n ƒë√∫ng:</strong> Th√™m d·∫•u <strong>(ƒê)</strong> ho·∫∑c <strong>(ƒê√∫ng)</strong> cu·ªëi ƒë√°p √°n</li>
                    <li><strong>V√≠ d·ª•:</strong> "A. ƒê√°p √°n A (ƒê)"</li>
                </ul>
            </div>
            <!-- Danh s√°ch file ƒë√£ l∆∞u (localStorage) -->
            <div class="format-guide" id="saved-files-section" style="margin-top:18px;">
                <h4>File ƒë√£ l∆∞u</h4>
                <div id="saved-list"></div>
                <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
                    <input type="file" id="import-quiz-input" accept="application/json" style="display:none" />
                    <button id="import-quiz-btn" type="button">Import quiz (.json)</button>
                    <span style="color:#6c757d; font-size:13px;">(B·∫°n c√≥ th·ªÉ export file .json v√† commit l√™n Git)</span>
                </div>
            </div>
        </div>
        
        <!-- Preview sau khi t·∫£i file: hi·ªán t·∫•t c·∫£ c√¢u h·ªèi v√† ƒë√°p √°n ƒë√∫ng -->
        <div id="preview-section" class="hidden">
            <h3>Danh s√°ch c√¢u h·ªèi (ƒë√°p √°n ƒë√∫ng ƒë∆∞·ª£c t√¥ s√°ng)</h3>
            <div id="preview-list" class="preview-list"></div>
            <div class="mode-buttons">
                <button id="back-upload-btn" type="button">Quay l·∫°i T·∫£i file</button>
                <button id="start-test-btn">B·∫Øt ƒë·∫ßu Ki·ªÉm tra</button>
                <button id="start-practice-btn">B·∫Øt ƒë·∫ßu Luy·ªán t·∫≠p</button>
            </div>
        </div>

        <div id="quiz-section" class="hidden">
            <div class="header-section">
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress" id="progress-bar"></div>
                    </div>
                    <div class="progress-text">
                        <span id="current-question">C√¢u 1</span>
                        <span id="progress-percent"></span>
                    </div>
                </div>
                
                <div class="download-section">
                    <button id="back-preview-btn" style="display:none">Quay l·∫°i Danh s√°ch</button>
                    <button id="download-btn">T·∫£i K·∫øt Qu·∫£</button>
                </div>
            </div>
            
            <div id="quiz-container">
                <div class="question-container">
                    <div class="question-number" id="question-number">C√¢u 1</div>
                    <div class="question-text" id="question-text"></div>
                    <div class="options-container" id="options-container"></div>
                    <div class="feedback" id="feedback"></div>
                </div>
                
                <div class="button-container">
                    <button id="prev-btn" disabled>Quay l·∫°i</button>
                    <button id="next-btn">Ti·∫øp theo</button>
                </div>
            </div>

            <!-- Ch·∫ø ƒë·ªô ki·ªÉm tra: hi·ªÉn th·ªã to√†n b·ªô c√¢u h·ªèi ƒë·ªÉ ch·ªçn v√† n·ªôp b√†i -->
            <div id="test-section" class="hidden">
                <form id="test-form"></form>
                <button id="submit-test-btn" type="button">N·ªôp b√†i</button>
            </div>
            
            <div class="result-container" id="result-container">
                <div class="result-title">K·∫æT QU·∫¢ B√ÄI TR·∫ÆC NGHI·ªÜM</div>
                <div class="score" id="score">0/0</div>
                <div class="result-details" id="result-details"></div>
                <button id="restart-btn">L√†m l·∫°i b√†i tr·∫Øc nghi·ªám</button>
            </div>
        </div>
    </div>

    <!-- Th∆∞ vi·ªán ƒë·ªÉ ƒë·ªçc file DOCX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.17/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        // Bi·∫øn to√†n c·ª•c
        let originalQuestions = [];
        let shuffledQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let correctAnswersCount = 0;
        let shuffleQuestionsEnabled = true;
        let shuffleOptionsEnabled = true;

        // DOM Elements
        const uploadSection = document.getElementById('upload-section');
        const fileInput = document.getElementById('file-input');
        const uploadBtn = document.getElementById('upload-btn');
        const fileInfo = document.getElementById('file-info');
        const shuffleQuestionsCheckbox = document.getElementById('shuffle-questions');
        const shuffleOptionsCheckbox = document.getElementById('shuffle-options');
        const quizSection = document.getElementById('quiz-section');
    const previewSection = document.getElementById('preview-section');
    const previewList = document.getElementById('preview-list');
    const startTestBtn = document.getElementById('start-test-btn');
    const startPracticeBtn = document.getElementById('start-practice-btn');
    const backUploadBtn = document.getElementById('back-upload-btn');
        const quizContainer = document.getElementById('quiz-container');
    const testSection = document.getElementById('test-section');
    const testForm = document.getElementById('test-form');
    const submitTestBtn = document.getElementById('submit-test-btn');
        const resultContainer = document.getElementById('result-container');
        const questionNumberElement = document.getElementById('question-number');
        const questionTextElement = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const feedbackElement = document.getElementById('feedback');
        const prevButton = document.getElementById('prev-btn');
        const nextButton = document.getElementById('next-btn');
    const downloadButton = document.getElementById('download-btn');
    const backPreviewBtn = document.getElementById('back-preview-btn');
        const progressBar = document.getElementById('progress-bar');
        const currentQuestionElement = document.getElementById('current-question');
        const progressPercentElement = document.getElementById('progress-percent');
        const scoreElement = document.getElementById('score');
        const resultDetailsElement = document.getElementById('result-details');
        const restartButton = document.getElementById('restart-btn');

        // S·ª± ki·ªán cho n√∫t upload
        uploadBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // S·ª± ki·ªán khi ch·ªçn file
        fileInput.addEventListener('change', handleFileSelect);

        // S·ª± ki·ªán k√©o th·∫£ file
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });

        // S·ª± ki·ªán cho checkbox
        shuffleQuestionsCheckbox.addEventListener('change', function() {
            shuffleQuestionsEnabled = this.checked;
        });

        shuffleOptionsCheckbox.addEventListener('change', function() {
            shuffleOptionsEnabled = this.checked;
        });

        // X·ª≠ l√Ω file ƒë∆∞·ª£c ch·ªçn
        function handleFileSelect() {
            const file = fileInput.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.docx')) {
                fileInfo.textContent = 'Vui l√≤ng ch·ªçn file DOCX!';
                fileInfo.style.color = 'red';
                return;
            }
            
            fileInfo.textContent = `ƒê√£ ch·ªçn: ${file.name}`;
            fileInfo.style.color = 'green';
            
            // ƒê·ªçc file DOCX
            readDocxFile(file);
        }

        // ƒê·ªçc file DOCX
        function readDocxFile(file) {
            fileInfo.textContent = 'ƒêang x·ª≠ l√Ω file...';
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const arrayBuffer = event.target.result;
                
                mammoth.extractRawText({arrayBuffer: arrayBuffer})
                    .then(function(result) {
                        const text = result.value;
                        processDocxContent(text);
                    })
                    .catch(function(error) {
                        console.error(error);
                        fileInfo.textContent = 'L·ªói khi ƒë·ªçc file DOCX!';
                        fileInfo.style.color = 'red';
                    });
            };
            reader.readAsArrayBuffer(file);
        }

        // X·ª≠ l√Ω n·ªôi dung DOCX
        function processDocxContent(text) {
            // T√°ch n·ªôi dung th√†nh c√°c d√≤ng v√† chu·∫©n h√≥a kho·∫£ng tr·∫Øng/k√Ω t·ª± ƒë·∫∑c bi·ªát
            const rawLines = text
                .split(/\r?\n/)
                .map(normalizeTextLine)
                .filter(line => line.trim() !== '');

            // T√°ch th√™m c√°c tr∆∞·ªùng h·ª£p nhi·ªÅu c√¢u h·ªèi n·∫±m tr√™n c√πng m·ªôt d√≤ng (v√≠ d·ª•: ... D. ... C√¢u 33: ...)
            const lines = [];
            rawLines.forEach(l => {
                const parts = splitInlineQuestions(l);
                parts.forEach(p => { if (p.trim()) lines.push(p.trim()); });
            });
            
            // Ph√¢n t√≠ch c·∫•u tr√∫c c√¢u h·ªèi t·ª´ DOCX
            originalQuestions = parseQuestionsFromText(lines);
            
            if (originalQuestions.length === 0) {
                fileInfo.textContent = 'Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi trong file!';
                fileInfo.style.color = 'red';
                return;
            }
            
            fileInfo.textContent = `ƒê√£ t√¨m th·∫•y ${originalQuestions.length} c√¢u h·ªèi!`;
            fileInfo.style.color = 'green';
            
            // Hi·ªÉn th·ªã preview + ch·ªçn ch·∫ø ƒë·ªô v·ªõi th·ª© t·ª± g·ªëc (kh√¥ng ƒë·∫£o)
            showPreview(originalQuestions);

            // L∆∞u quiz ƒë√£ parse v√†o localStorage ƒë·ªÉ d√πng l·∫°i sau n√†y
            try {
                const saveName = `${new Date().toISOString().slice(0,19).replace('T',' ')} - ${fileInput.files[0] ? fileInput.files[0].name : 'quiz'}`;
                saveQuizToStorage(saveName, originalQuestions);
                loadSavedQuizzes();
            } catch (e) {
                console.warn('Kh√¥ng th·ªÉ l∆∞u quiz v√†o localStorage', e);
            }
        }

        // Chu·∫©n h√≥a t·ª´ng d√≤ng text (lo·∫°i b·ªè NBSP, g·ªôp kho·∫£ng tr·∫Øng, thay ‚Äì ‚Äî th√†nh -)
        function normalizeTextLine(s) {
            return s
                .replace(/\u00A0/g, ' ')
                .replace(/[\t ]+/g, ' ')
                .replace(/[‚Äì‚Äî]/g, '-')
                .trim();
        }

        // N·∫øu m·ªôt d√≤ng ch·ª©a nhi·ªÅu marker "C√¢u <s·ªë>" th√¨ t√°ch th√†nh c√°c d√≤ng ri√™ng cho t·ª´ng c√¢u h·ªèi
        function splitInlineQuestions(line) {
            const result = [];
            const re = /C√¢u\s*\d+\s*(?:[:\.\)\-‚Äì])?/gi;
            let lastIndex = 0;
            let m;
            const matches = [];
            while ((m = re.exec(line)) !== null) {
                matches.push({ index: m.index, text: m[0] });
            }
            if (matches.length === 0) return [line];

            // N·∫øu marker ƒë·∫ßu ti√™n kh√¥ng ·ªü v·ªã tr√≠ 0, gi·ªØ ph·∫ßn tr∆∞·ªõc ƒë√≥ nh∆∞ m·ªôt ƒëo·∫°n ri√™ng (th∆∞·ªùng l√† ph·∫ßn ƒëu√¥i c·ªßa c√¢u tr∆∞·ªõc)
            if (matches[0].index > 0) {
                result.push(line.substring(0, matches[0].index).trim());
            }
            for (let i = 0; i < matches.length; i++) {
                const start = matches[i].index;
                const end = i + 1 < matches.length ? matches[i + 1].index : line.length;
                result.push(line.substring(start, end).trim());
            }
            return result;
        }

        // Ph√¢n t√≠ch c√¢u h·ªèi t·ª´ vƒÉn b·∫£n (m·∫°nh h∆°n, bao ph·ªß nhi·ªÅu ƒë·ªãnh d·∫°ng)
        function parseQuestionsFromText(lines) {
            const parsedQuestions = [];
            let currentQuestion = null;

            // ƒê·∫©y c√¢u h·ªèi hi·ªán t·∫°i v√†o m·∫£ng n·∫øu h·ª£p l·ªá
            function pushCurrentIfValid() {
                if (currentQuestion && currentQuestion.options.length > 0) {
                    if (currentQuestion.correctAnswer === -1) {
                        currentQuestion.correctAnswer = 0;
                        currentQuestion.originalCorrectAnswer = 0;
                    }
                    parsedQuestions.push(currentQuestion);
                }
            }

            // T·∫°o c√¢u h·ªèi m·ªõi t·ª´ d√≤ng raw (c√≥ th·ªÉ ch·ª©a ƒë√°p √°n tr√™n c√πng d√≤ng)
            function startNewQuestion(rawLine) {
                // H·ªó tr·ª£: "C√¢u 1", "C√¢u 1:", "C√¢u1.", "1.", "1)", "1:", "1-"
                let text = rawLine.replace(/^(?:C√¢u\s*)?\d+\s*(?:[:\.\)\-‚Äì])?\s*/i, '').trim();

                // T√¨m c√°c marker A./B./C./D. trong c√πng d√≤ng (c·∫£ a./b.)
                const firstMarkerRe = /(?:^|\s)([A-Da-d][\.:\)])\s*/;
                const first = firstMarkerRe.exec(text);
                if (first) {
                    const firstIdx = first.index + (first[0].length - first[1].length);
                    const qText = text.substring(0, firstIdx).trim();
                    const optionsText = text.substring(firstIdx).trim();
                    // C·∫Øt t·ª´ng ƒë√°p √°n ƒë·∫øn tr∆∞·ªõc marker k·∫ø ti·∫øp
                    const optionMatches = optionsText.match(/([A-Da-d][\.:\)]\s*[^A-Da-d]+?)(?=\s+[A-Da-d][\.:\)]|$)/g);
                    const opts = [];
                    if (optionMatches) {
                        optionMatches.forEach(chunk => {
                            const optText = chunk.replace(/^[A-Da-d][\.:\)]\s*/,'').trim();
                            if (optText) opts.push(optText);
                        });
                    }
                    return { question: qText, options: opts };
                }
                return { question: text, options: [] };
            }

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;

                // B·ªè qua c√°c d√≤ng ti√™u ƒë·ªÅ nh∆∞ "ƒê√°p √°n:" n·∫øu c√≥
                if (/^ƒë√°p\s*√°n\s*:*/i.test(line)) continue;

                // C√¢u h·ªèi m·ªõi
                if (/^(?:C√¢u\s*)?\d+\s*[:\.\)]/i.test(line)) {
                    pushCurrentIfValid();
                    const nq = startNewQuestion(line);
                    currentQuestion = {
                        question: nq.question,
                        options: [],
                        correctAnswer: -1,
                        originalCorrectAnswer: -1
                    };

                    // N·∫øu c√≥ ƒë√°p √°n tr√™n c√πng d√≤ng, th√™m ngay
                    if (nq.options && nq.options.length) {
                        nq.options.forEach(op => {
                            const optionIndex = currentQuestion.options.length;
                            const isCorrect = checkIfCorrectAnswer(op);
                            const cleanText = cleanAnswerText(op);
                            currentQuestion.options.push(cleanText);
                            if (isCorrect && currentQuestion.correctAnswer === -1) {
                                currentQuestion.correctAnswer = optionIndex;
                                currentQuestion.originalCorrectAnswer = optionIndex;
                            }
                        });
                    }
                    continue;
                }

                // D√≤ng ƒë√°p √°n ri√™ng
                if (/^[\-\u2022\u2023\u25CF\u25E6]?\s*[A-Da-d][\.:\)]/i.test(line) && currentQuestion) {
                    const optionText = line.replace(/^[\-\u2022\u2023\u25CF\u25E6]?\s*[A-Da-d][\.:\)]\s*/i, '').trim();
                    const optionIndex = currentQuestion.options.length;
                    const isCorrect = checkIfCorrectAnswer(optionText);
                    const cleanOptionText = cleanAnswerText(optionText);
                    currentQuestion.options.push(cleanOptionText);
                    if (isCorrect && currentQuestion.correctAnswer === -1) {
                        currentQuestion.correctAnswer = optionIndex;
                        currentQuestion.originalCorrectAnswer = optionIndex;
                    }
                    continue;
                }

                // Ph·∫ßn m·ªü r·ªông th√™m c·ªßa c√¢u h·ªèi (ch·ªâ khi ch∆∞a xu·∫•t hi·ªán ƒë√°p √°n)
                if (currentQuestion && currentQuestion.options.length === 0) {
                    currentQuestion.question += ' ' + line;
                }
            }

            // ƒê·∫©y c√¢u h·ªèi cu·ªëi c√πng
            pushCurrentIfValid();

            return parsedQuestions;
        }

        // Ki·ªÉm tra xem ƒë√°p √°n c√≥ ph·∫£i l√† ƒë√°p √°n ƒë√∫ng kh√¥ng
        function checkIfCorrectAnswer(optionText) {
            // C√°c m·∫´u nh·∫≠n di·ªán ƒë√°p √°n ƒë√∫ng
            const correctPatterns = [
                /\s*\(ƒê\)\s*$/i,
                /\s*\(ƒê√∫ng\)\s*$/i,
                /\s*\*\s*$/,
                /\s*‚úì\s*$/,
                /\s*‚Üí\s*$/,
                /\s*\[X\]\s*$/i,
            ];
            
            return correctPatterns.some(pattern => pattern.test(optionText));
        }

        // L√†m s·∫°ch ƒë√°p √°n (lo·∫°i b·ªè k√Ω hi·ªáu ƒë√°p √°n ƒë√∫ng)
        function cleanAnswerText(optionText) {
            return optionText
                .replace(/\s*\(ƒê\)\s*$/i, '')
                .replace(/\s*\(ƒê√∫ng\)\s*$/i, '')
                .replace(/\s*\*\s*$/, '')
                .replace(/\s*‚úì\s*$/, '')
                .replace(/\s*‚Üí\s*$/, '')
                .replace(/\s*\[X\]\s*$/i, '')
                .trim();
        }

        // H√†m ƒë·∫£o m·∫£ng ng·∫´u nhi√™n (Fisher-Yates shuffle)
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // ƒê·∫£o c√¢u h·ªèi v√† ƒë√°p √°n
        function shuffleQuestionsAndOptions() {
            let questionsToShuffle = [...originalQuestions];
            
            // ƒê·∫£o th·ª© t·ª± c√¢u h·ªèi n·∫øu ƒë∆∞·ª£c b·∫≠t
            if (shuffleQuestionsEnabled) {
                questionsToShuffle = shuffleArray(questionsToShuffle);
            }
            
            // ƒê·∫£o th·ª© t·ª± ƒë√°p √°n cho t·ª´ng c√¢u h·ªèi n·∫øu ƒë∆∞·ª£c b·∫≠t
            if (shuffleOptionsEnabled) {
                questionsToShuffle = questionsToShuffle.map(question => {
                    // T·∫°o m·∫£ng ch·ªâ s·ªë ƒë√°p √°n
                    const optionIndices = question.options.map((_, index) => index);
                    // ƒê·∫£o th·ª© t·ª± ch·ªâ s·ªë
                    const shuffledIndices = shuffleArray(optionIndices);
                    
                    // T·∫°o ƒë√°p √°n m·ªõi v·ªõi th·ª© t·ª± ƒë√£ ƒë·∫£o
                    const newOptions = shuffledIndices.map(index => question.options[index]);
                    
                    // T√¨m v·ªã tr√≠ m·ªõi c·ªßa ƒë√°p √°n ƒë√∫ng
                    const newCorrectAnswer = shuffledIndices.indexOf(question.correctAnswer);
                    
                    return {
                        ...question,
                        options: newOptions,
                        correctAnswer: newCorrectAnswer
                    };
                });
            }
            
            return questionsToShuffle;
        }

        // Chu·∫©n b·ªã c√¢u h·ªèi theo c√†i ƒë·∫∑t hi·ªán t·∫°i (√°p d·ª•ng ƒë·∫£o n·∫øu c·∫ßn)
        function prepareQuestions() {
            return shuffleQuestionsAndOptions();
        }

        // Hi·ªÉn th·ªã Preview: t·∫•t c·∫£ c√¢u h·ªèi v·ªõi ƒë√°p √°n ƒë√∫ng ƒë∆∞·ª£c t√¥ s√°ng
        function showPreview(questions) {
            // ·∫®n upload, hi·ªÉn th·ªã preview; ·∫©n quiz/test/result
            uploadSection.classList.add('hidden');
            quizSection.classList.remove('hidden');
            // Trong quizSection, t·∫°m ·∫©n c√°c ph·∫ßn con kh√°c
            quizContainer.style.display = 'none';
            testSection.classList.add('hidden');
            resultContainer.style.display = 'none';

            previewSection.classList.remove('hidden');
            previewList.innerHTML = '';
            if (backPreviewBtn) backPreviewBtn.style.display = 'none';
            if (downloadButton) downloadButton.style.display = 'none';

            questions.forEach((q, qi) => {
                const wrap = document.createElement('div');
                wrap.className = 'preview-question';

                const title = document.createElement('div');
                title.className = 'pq-title';
                title.textContent = `C√¢u ${qi + 1}: ${q.question}`;
                wrap.appendChild(title);

                q.options.forEach((opt, oi) => {
                    const row = document.createElement('div');
                    row.className = 'pq-option' + (oi === q.correctAnswer ? ' correct' : '');
                    row.textContent = `${String.fromCharCode(65 + oi)}. ${opt}`;
                    wrap.appendChild(row);
                });

                previewList.appendChild(wrap);
            });

            // C·∫≠p nh·∫≠t header
            currentQuestionElement.textContent = `T·∫•t c·∫£ c√¢u h·ªèi (${questions.length})`;
            progressBar.style.width = '0%';
            progressPercentElement.textContent = '';
        }

        // Kh·ªüi t·∫°o b√†i tr·∫Øc nghi·ªám
        function initializeQuiz(questions = null) {
            // D√πng danh s√°ch ƒë√£ chu·∫©n b·ªã n·∫øu c√≥, ng∆∞·ª£c l·∫°i t·ª± chu·∫©n b·ªã
            shuffledQuestions = questions ? questions : prepareQuestions();
            
            // ·∫®n ph·∫ßn upload, hi·ªÉn th·ªã ph·∫ßn quiz
            uploadSection.classList.add('hidden');
            quizSection.classList.remove('hidden');
            previewSection.classList.add('hidden');
            testSection.classList.add('hidden');
            // ƒë·∫£m b·∫£o hi·ªÉn th·ªã ch·∫ø ƒë·ªô luy·ªán t·∫≠p (t·ª´ng c√¢u) v√† ·∫©n k·∫øt qu·∫£
            quizContainer.style.display = 'block';
            resultContainer.style.display = 'none';
            if (backPreviewBtn) backPreviewBtn.style.display = 'inline-block';
            if (downloadButton) downloadButton.style.display = 'inline-block';
            
            // Kh·ªüi t·∫°o bi·∫øn
            currentQuestionIndex = 0;
            userAnswers = new Array(shuffledQuestions.length).fill(null);
            correctAnswersCount = 0;
            
            // Hi·ªÉn th·ªã c√¢u h·ªèi ƒë·∫ßu ti√™n
            displayQuestion();
        }

        // B·∫Øt ƒë·∫ßu ch·∫ø ƒë·ªô Luy·ªán t·∫≠p (t·ª´ng c√¢u nh∆∞ hi·ªán t·∫°i)
        function startPracticeMode() {
            // Luy·ªán t·∫≠p nh∆∞ "l√†m l·∫°i" tr∆∞·ªõc ƒë√¢y: chu·∫©n b·ªã l·∫°i (ƒë·∫£o n·∫øu b·∫≠t), reset v√† v√†o flow t·ª´ng c√¢u
            const prepared = prepareQuestions();
            initializeQuiz(prepared);
        }

        // D·ª±ng form cho ch·∫ø ƒë·ªô Ki·ªÉm tra (hi·ªÉn th·ªã to√†n b·ªô ƒë·ªÉ ch·ªçn v√† n·ªôp)
        function renderTestForm() {
            testForm.innerHTML = '';
            shuffledQuestions.forEach((q, qi) => {
                const block = document.createElement('div');
                block.className = 'test-question';

                const title = document.createElement('div');
                title.className = 'tq-title';
                title.textContent = `C√¢u ${qi + 1}: ${q.question}`;
                block.appendChild(title);

                const optsWrap = document.createElement('div');
                optsWrap.className = 'test-options';
                q.options.forEach((opt, oi) => {
                    const id = `q${qi}-o${oi}`;
                    const label = document.createElement('label');
                    label.setAttribute('for', id);

                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `q${qi}`;
                    radio.id = id;
                    radio.value = String(oi);

                    const text = document.createTextNode(` ${String.fromCharCode(65 + oi)}. ${opt}`);
                    label.appendChild(radio);
                    label.appendChild(text);

                    optsWrap.appendChild(label);
                });

                block.appendChild(optsWrap);
                testForm.appendChild(block);
            });
        }

        function startTestMode() {
            // M·ªói l·∫ßn b·∫Øt ƒë·∫ßu ki·ªÉm tra s·∫Ω chu·∫©n b·ªã l·∫°i c√¢u h·ªèi/ƒë√°p √°n theo c√†i ƒë·∫∑t (ƒë·∫£o n·∫øu b·∫≠t)
            const prepared = prepareQuestions();
            shuffledQuestions = prepared;

            // Hi·ªÉn th·ªã ph·∫ßn quiz (ƒë·ªÉ d√πng header + k·∫øt qu·∫£), ·∫©n luy·ªán t·∫≠p, ·∫©n preview
            quizSection.classList.remove('hidden');
            previewSection.classList.add('hidden');
            quizContainer.style.display = 'none';
            resultContainer.style.display = 'none';
            testSection.classList.remove('hidden');
            if (backPreviewBtn) backPreviewBtn.style.display = 'inline-block';
            if (downloadButton) downloadButton.style.display = 'inline-block';

            currentQuestionElement.textContent = `B√†i ki·ªÉm tra (${prepared.length} c√¢u)`;
            progressBar.style.width = '0%';
            progressPercentElement.textContent = '';

            // L∆∞u m·∫£ng tr·∫£ l·ªùi r·ªóng cho t·∫•t c·∫£ c√¢u v√† ƒë·∫£m b·∫£o b·∫Øt ƒë·∫ßu t·ª´ c√¢u 1
            userAnswers = new Array(prepared.length).fill(null);
            // ƒë·∫£m b·∫£o index b·∫Øt ƒë·∫ßu t·ª´ 0 (C√¢u 1)
            currentQuestionIndex = 0;
            renderTestForm();

            // ƒê·∫£m b·∫£o tr√™n thi·∫øt b·ªã di ƒë·ªông/cu·ªôn ch·∫≠m: ch·ªù m·ªôt ch√∫t ƒë·ªÉ DOM render xong r·ªìi cu·ªôn/focus
            setTimeout(() => {
                if (testSection) {
                    try {
                        // ∆Øu ti√™n scrollIntoView
                        testSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } catch (e) {
                        // fallback
                        const y = testSection.getBoundingClientRect().top + window.scrollY - 10;
                        window.scrollTo({ top: y, behavior: 'smooth' });
                    }

                    // focus v√†o radio ƒë·∫ßu ti√™n n·∫øu c√≥, ƒë·ªÉ tr√¨nh duy·ªát kh√¥ng t·ª± chuy·ªÉn focus v√†o ph·∫ßn kh√°c
                    const firstRadio = testForm.querySelector('input[type=radio]');
                    if (firstRadio) {
                        try { firstRadio.focus(); } catch (e) { /* ignore */ }
                    } else {
                        // n·∫øu kh√¥ng c√≥ radio (√≠t kh·∫£ nƒÉng), focus v√†o n√∫t N·ªôp ƒë·ªÉ tr√°nh focus l√™n ph·∫ßn cu·ªëi
                        try { submitTestBtn && submitTestBtn.focus(); } catch (e) {}
                    }
                }
            }, 120);
        }

        // X·ª≠ l√Ω n·ªôp b√†i ·ªü ch·∫ø ƒë·ªô Ki·ªÉm tra
        function submitTest() {
            // Thu th·∫≠p ƒë√°p √°n ng∆∞·ªùi d√πng t·ª´ form
            shuffledQuestions.forEach((q, qi) => {
                const chosen = testForm.querySelector(`input[name="q${qi}"]:checked`);
                userAnswers[qi] = chosen ? parseInt(chosen.value, 10) : null;
            });

            // ·∫®n form, hi·ªán k·∫øt qu·∫£
            testSection.classList.add('hidden');
            showResults();
        }

        function goToPreview() {
            showPreview(originalQuestions);
        }

        function goToUpload() {
            // Hi·ªÉn th·ªã khu v·ª±c t·∫£i file; ·∫©n c√°c ph·∫ßn c√≤n l·∫°i
            uploadSection.classList.remove('hidden');
            quizSection.classList.add('hidden');
            previewSection.classList.add('hidden');
            // ·∫®n n√∫t quay l·∫°i danh s√°ch ·ªü header n·∫øu ƒëang hi·ªán
            if (backPreviewBtn) backPreviewBtn.style.display = 'none';
        }

        // H√†m hi·ªÉn th·ªã c√¢u h·ªèi
        function displayQuestion() {
            if (shuffledQuestions.length === 0) return;
            
            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            const selectedIndex = userAnswers[currentQuestionIndex];
            
            // C·∫≠p nh·∫≠t s·ªë c√¢u h·ªèi
            questionNumberElement.textContent = `C√¢u ${currentQuestionIndex + 1}`;
            currentQuestionElement.textContent = `C√¢u ${currentQuestionIndex + 1}/${shuffledQuestions.length}`;
            
            // C·∫≠p nh·∫≠t n·ªôi dung c√¢u h·ªèi
            questionTextElement.textContent = currentQuestion.question;
            
            // C·∫≠p nh·∫≠t thanh ti·∫øn tr√¨nh
            const progressPercent = ((currentQuestionIndex + 1) / shuffledQuestions.length) * 100;
            progressBar.style.width = `${progressPercent}%`;
            progressPercentElement.textContent = `${Math.round(progressPercent)}`;
            
            // X√≥a c√°c l·ª±a ch·ªçn c≈©
            optionsContainer.innerHTML = '';
            const optionEls = [];
            
            // T·∫°o c√°c l·ª±a ch·ªçn m·ªõi
            currentQuestion.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.classList.add('option');
                optionElement.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                
                // Ki·ªÉm tra n·∫øu ƒë√£ ch·ªçn ƒë√°p √°n n√†y tr∆∞·ªõc ƒë√≥
                if (selectedIndex === index) {
                    optionElement.classList.add('selected');
                    
                    // Ki·ªÉm tra xem ƒë√°p √°n ƒë√£ ch·ªçn c√≥ ƒë√∫ng kh√¥ng
                    if (index === currentQuestion.correctAnswer) {
                        optionElement.classList.add('correct');
                        feedbackElement.textContent = "Ch√≠nh x√°c!";
                        feedbackElement.classList.add('correct');
                        feedbackElement.classList.remove('incorrect');
                    } else {
                        optionElement.classList.add('incorrect');
                        const correctLetter = String.fromCharCode(65 + currentQuestion.correctAnswer);
                        const correctText = currentQuestion.options[currentQuestion.correctAnswer];
                        feedbackElement.textContent = `Sai r·ªìi! ƒê√°p √°n ƒë√∫ng l√†: ${correctLetter}. ${correctText}`;
                        feedbackElement.classList.add('incorrect');
                        feedbackElement.classList.remove('correct');
                    }
                }
                
                // Ch·ªâ cho click khi ch∆∞a ch·ªçn ƒë√°p √°n n√†o
                if (selectedIndex === null) {
                    optionElement.addEventListener('click', () => selectOption(index));
                } else {
                    optionElement.classList.add('disabled');
                }
                optionsContainer.appendChild(optionElement);
                optionEls.push(optionElement);
            });
            
            // N·∫øu ƒë√£ ch·ªçn sai, t√¥ s√°ng ƒë√°p √°n ƒë√∫ng
            if (selectedIndex !== null && selectedIndex !== undefined && selectedIndex !== currentQuestion.correctAnswer) {
                const correctEl = optionEls[currentQuestion.correctAnswer];
                if (correctEl) correctEl.classList.add('correct');
            }
            
            // N·∫øu ch∆∞a ch·ªçn g√¨, ·∫©n feedback
            if (selectedIndex === null) {
                feedbackElement.textContent = '';
                feedbackElement.classList.remove('correct', 'incorrect');
            }
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t
            prevButton.disabled = currentQuestionIndex === 0;
            // Cho ph√©p chuy·ªÉn ti·∫øp n·∫øu ƒë√£ ch·ªçn b·∫•t k·ª≥ ƒë√°p √°n n√†o
            nextButton.disabled = selectedIndex === null;
        }

        // H√†m ch·ªçn ƒë√°p √°n
        function selectOption(optionIndex) {
            // ƒê√°nh d·∫•u ƒë√°p √°n ƒë√£ ch·ªçn
            userAnswers[currentQuestionIndex] = optionIndex;
            
            // Hi·ªÉn th·ªã l·∫°i c√¢u h·ªèi ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i v√† hi·ªÉn th·ªã ƒë√°p √°n ƒë√∫ng n·∫øu ch·ªçn sai
            displayQuestion();
            
            // Cho ph√©p chuy·ªÉn ti·∫øp d√π ƒë√∫ng hay sai (mi·ªÖn l√† ƒë√£ ch·ªçn)
            nextButton.disabled = false;
        }

        // H√†m chuy·ªÉn ƒë·∫øn c√¢u h·ªèi ti·∫øp theo
        function nextQuestion() {
            if (currentQuestionIndex < shuffledQuestions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                // N·∫øu ƒë√£ ƒë·∫øn c√¢u cu·ªëi, hi·ªÉn th·ªã k·∫øt qu·∫£
                showResults();
            }
        }

        // H√†m quay l·∫°i c√¢u h·ªèi tr∆∞·ªõc
        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        // H√†m hi·ªÉn th·ªã k·∫øt qu·∫£
        function showResults() {
            quizContainer.style.display = 'none';
            resultContainer.style.display = 'block';
            
            // T√≠nh ƒëi·ªÉm d·ª±a tr√™n c√¢u ƒë√£ ch·ªçn
            let score = 0;
            shuffledQuestions.forEach((question, index) => {
                if (userAnswers[index] === question.correctAnswer) score++;
            });
            // L∆∞u l·∫°i ƒë·ªÉ xu·∫•t file k·∫øt qu·∫£
            correctAnswersCount = score;
            scoreElement.textContent = `${score}/${shuffledQuestions.length}`;
            
            // Hi·ªÉn th·ªã chi ti·∫øt k·∫øt qu·∫£
            resultDetailsElement.innerHTML = '';
            shuffledQuestions.forEach((question, index) => {
                const resultItem = document.createElement('div');
                resultItem.classList.add('result-item');
                
                if (userAnswers[index] === question.correctAnswer) {
                    resultItem.classList.add('correct');
                    resultItem.innerHTML = `
                        <span>C√¢u ${index + 1}: ƒê√∫ng</span>
                        <span>+1 ƒëi·ªÉm</span>
                    `;
                } else {
                    resultItem.classList.add('incorrect');
                    resultItem.innerHTML = `
                        <span>C√¢u ${index + 1}: Sai</span>
                        <span>0 ƒëi·ªÉm</span>
                    `;
                }
                
                resultDetailsElement.appendChild(resultItem);
            });
        }

        // H√†m kh·ªüi ƒë·ªông l·∫°i b√†i tr·∫Øc nghi·ªám
        function restartQuiz() {
            // Quay v·ªÅ m√†n h√¨nh preview v·ªõi th·ª© t·ª± g·ªëc (kh√¥ng ƒë·∫£o)
            showPreview(originalQuestions);
        }

        // H√†m t·∫£i k·∫øt qu·∫£
        function downloadResults() {
            let resultText = "K·∫æT QU·∫¢ B√ÄI TR·∫ÆC NGHI·ªÜM\n\n";
            resultText += `S·ªë c√¢u ƒë√∫ng: ${correctAnswersCount}/${shuffledQuestions.length}\n\n`;
            
            shuffledQuestions.forEach((question, index) => {
                resultText += `C√¢u ${index + 1}: ${question.question}\n`;
                resultText += `ƒê√°p √°n c·ªßa b·∫°n: ${userAnswers[index] !== null ? String.fromCharCode(65 + userAnswers[index]) : 'Ch∆∞a tr·∫£ l·ªùi'}\n`;
                resultText += `ƒê√°p √°n ƒë√∫ng: ${String.fromCharCode(65 + question.correctAnswer)}\n`;
                resultText += `K·∫øt qu·∫£: ${userAnswers[index] === question.correctAnswer ? 'ƒê√öNG' : 'SAI'}\n\n`;
            });
            
            const blob = new Blob([resultText], { type: 'text/plain;charset=utf-8' });
            saveAs(blob, 'ket_qua_trac_nghiem.txt');
        }

        // ========== LocalStorage: L∆∞u/Load c√°c quiz ƒë√£ parse ==========
        const SAVED_PREFIX = 'tracnghiem_quiz_';

        function saveQuizToStorage(name, questions) {
            const key = SAVED_PREFIX + Date.now();
            const payload = {
                name: name,
                created: Date.now(),
                questions: questions
            };
            localStorage.setItem(key, JSON.stringify(payload));
        }

        function loadSavedQuizzes() {
            const savedListEl = document.getElementById('saved-list');
            savedListEl.innerHTML = '';
            const keys = Object.keys(localStorage).filter(k => k.startsWith(SAVED_PREFIX)).sort().reverse();
            if (keys.length === 0) {
                savedListEl.textContent = 'Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c l∆∞u.';
                return;
            }
            keys.forEach(k => {
                try {
                    const item = JSON.parse(localStorage.getItem(k));
                    const row = document.createElement('div');
                    row.style.display = 'flex';
                    row.style.justifyContent = 'space-between';
                    row.style.alignItems = 'center';
                    row.style.padding = '6px 0';

                    const left = document.createElement('div');
                    left.textContent = `${item.name} (${item.questions.length} c√¢u)`;

                    const actions = document.createElement('div');
                    actions.style.display = 'flex';
                    actions.style.gap = '8px';

                    const openBtn = document.createElement('button');
                    openBtn.type = 'button';
                    openBtn.textContent = 'M·ªü';
                    openBtn.addEventListener('click', () => openSavedQuiz(k));

                    const exportBtn = document.createElement('button');
                    exportBtn.type = 'button';
                    exportBtn.textContent = 'Export';
                    exportBtn.style.background = '#2ecc71';
                    exportBtn.style.color = '#fff';
                    exportBtn.addEventListener('click', () => {
                        try {
                            const blob = new Blob([JSON.stringify(item, null, 2)], { type: 'application/json' });
                            const name = (item.name || 'quiz').replace(/[^a-z0-9\-_. ]/gi, '_') + '.json';
                            saveAs(blob, name);
                        } catch (e) {
                            console.error('Export failed', e);
                        }
                    });

                    const delBtn = document.createElement('button');
                    delBtn.type = 'button';
                    delBtn.textContent = 'X√≥a';
                    delBtn.style.background = '#e74c3c';
                    delBtn.style.color = '#fff';
                    delBtn.addEventListener('click', () => {
                        if (confirm('X√≥a file ƒë√£ l∆∞u n√†y?')) {
                            deleteSavedQuiz(k);
                            loadSavedQuizzes();
                        }
                    });

                    actions.appendChild(openBtn);
                    actions.appendChild(exportBtn);
                    actions.appendChild(delBtn);
                    row.appendChild(left);
                    row.appendChild(actions);
                    savedListEl.appendChild(row);
                } catch (e) {
                    console.warn('Invalid saved quiz', k, e);
                }
            });
        }

        function openSavedQuiz(key) {
            try {
                const item = JSON.parse(localStorage.getItem(key));
                if (!item || !item.questions) return;
                // Set originalQuestions to saved one and show preview
                originalQuestions = item.questions;
                fileInfo.textContent = `ƒê√£ m·ªü: ${item.name}`;
                fileInfo.style.color = 'green';
                showPreview(originalQuestions);
            } catch (e) {
                console.error('Kh√¥ng th·ªÉ m·ªü quiz ƒë√£ l∆∞u', e);
            }
        }

        function deleteSavedQuiz(key) {
            localStorage.removeItem(key);
        }

        // Load saved list on startup
        try { loadSavedQuizzes(); } catch (e) { /* ignore */ }

        // Import/export wiring
        const importInput = document.getElementById('import-quiz-input');
        const importBtn = document.getElementById('import-quiz-btn');
        if (importBtn && importInput) {
            importBtn.addEventListener('click', () => importInput.click());
            importInput.addEventListener('change', (e) => {
                const f = e.target.files[0];
                if (!f) return;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    try {
                        const payload = JSON.parse(evt.target.result);
                        // If payload contains questions array, save it
                        const name = payload.name || f.name.replace(/\.json$/i,'');
                        const key = SAVED_PREFIX + Date.now();
                        const toSave = {
                            name: name,
                            created: Date.now(),
                            questions: payload.questions || payload
                        };
                        localStorage.setItem(key, JSON.stringify(toSave));
                        loadSavedQuizzes();
                        alert('Import th√†nh c√¥ng.');
                    } catch (err) {
                        alert('Kh√¥ng th·ªÉ import file: ' + err.message);
                    }
                };
                reader.readAsText(f);
            });
        }

        // G√°n s·ª± ki·ªán cho c√°c n√∫t
    prevButton.addEventListener('click', prevQuestion);
    nextButton.addEventListener('click', nextQuestion);
    restartButton.addEventListener('click', restartQuiz);
    downloadButton.addEventListener('click', downloadResults);
    if (startPracticeBtn) startPracticeBtn.addEventListener('click', startPracticeMode);
    if (startTestBtn) startTestBtn.addEventListener('click', startTestMode);
    if (submitTestBtn) submitTestBtn.addEventListener('click', submitTest);
    if (backPreviewBtn) backPreviewBtn.addEventListener('click', goToPreview);
    if (backUploadBtn) backUploadBtn.addEventListener('click', goToUpload);
    </script>
</body>
</html>